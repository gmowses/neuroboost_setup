#!/bin/bash

## ===================================================================================================
##                           INSTALADOR DOCKER COMPOSE - NEUROBOOST DIGITAL
##                              TRAEFIK + PORTAINER + MINIO
## ===================================================================================================

## Cores
AMARELO="\e[33m"
VERDE="\e[32m"
VERMELHO="\e[31m"
BRANCO="\e[97m"
RESET="\e[0m"

## DomÃ­nio base
DOMINIO_BASE="neuroboost.digital"

## UsuÃ¡rio padrÃ£o
USUARIO_PADRAO="neuroboost"

## Arquivo de log
LOG_FILE="instalacao_$(date +%Y%m%d_%H%M%S).log"

## ===================================================================================================
##                                    VERIFICAÃ‡Ã•ES DE SISTEMA
## ===================================================================================================

## FunÃ§Ã£o para verificar requisitos do sistema
verificar_requisitos_sistema() {
    local erro=0
    
    echo "ðŸ” Verificando requisitos do sistema..."
    
    # Verifica se estÃ¡ executando como root
    if [ "$EUID" -ne 0 ]; then
        echo "âŒ ERRO: Este script deve ser executado como usuÃ¡rio root!"
        echo "   Execute: sudo ./Setup"
        echo "   UsuÃ¡rio atual: $(whoami) (UID: $EUID)"
        erro=1
    else
        echo "âœ… UsuÃ¡rio root confirmado (UID: $EUID)"
    fi
    
    # Verifica se Ã© Ubuntu
    if [ ! -f /etc/os-release ]; then
        echo "âŒ ERRO: NÃ£o foi possÃ­vel identificar o sistema operacional!"
        erro=1
    else
        # LÃª informaÃ§Ãµes do sistema
        . /etc/os-release
        
        # Verifica se Ã© Ubuntu
        if [ "$ID" != "ubuntu" ]; then
            echo "âŒ ERRO: Sistema operacional nÃ£o suportado!"
            echo "   Sistema detectado: $PRETTY_NAME"
            echo "   Sistema requerido: Ubuntu 24.04.2 LTS"
            erro=1
        else
            echo "âœ… Ubuntu detectado: $PRETTY_NAME"
            
            # Verifica versÃ£o especÃ­fica do Ubuntu
            if [ "$VERSION_ID" != "24.04" ]; then
                echo "âŒ ERRO: VersÃ£o do Ubuntu nÃ£o suportada!"
                echo "   VersÃ£o detectada: $VERSION_ID ($PRETTY_NAME)"
                echo "   VersÃ£o requerida: 24.04 (Ubuntu 24.04.2 LTS)"
                erro=1
            else
                echo "âœ… VersÃ£o do Ubuntu compatÃ­vel: $VERSION_ID"
                
                # Verifica se Ã© LTS
                if [[ "$VERSION" != *"LTS"* ]]; then
                    echo "âŒ ERRO: Esta nÃ£o Ã© uma versÃ£o LTS do Ubuntu!"
                    echo "   VersÃ£o detectada: $VERSION"
                    echo "   Requerido: Ubuntu 24.04.2 LTS"
                    erro=1
                else
                    echo "âœ… Ubuntu LTS confirmado: $VERSION"
                    
                    # VerificaÃ§Ã£o adicional para patch version (recomendada)
                    if command -v lsb_release >/dev/null 2>&1; then
                        local full_version=$(lsb_release -r -s)
                        echo "â„¹ï¸  VersÃ£o completa detectada: $full_version"
                        if [ "$full_version" = "24.04" ]; then
                            echo "âœ… Ubuntu 24.04 LTS confirmado"
                        else
                            echo "âš ï¸  VersÃ£o patch diferente detectada: $full_version"
                            echo "   Recomendado: 24.04.2, mas 24.04.x deve funcionar"
                        fi
                    fi
                fi
            fi
        fi
    fi
    
    # Se houver erro, interrompe a execuÃ§Ã£o
    if [ $erro -eq 1 ]; then
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                    REQUISITOS NÃƒO ATENDIDOS                   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âŒ Este script sÃ³ pode ser executado em:"
        echo "   â€¢ Ubuntu 24.04.2 LTS"
        echo "   â€¢ Como usuÃ¡rio root (sudo)"
        echo ""
        echo "ðŸ”§ Para corrigir:"
        echo "   1. Use Ubuntu 24.04.2 LTS"
        echo "   2. Execute: sudo ./Setup"
        echo ""
        exit 1
    fi
    
    echo ""
    echo "âœ… Todos os requisitos de sistema atendidos!"
    echo ""
}

## ===================================================================================================
##                                         FUNÃ‡Ã•ES AUXILIARES
## ===================================================================================================

## FunÃ§Ã£o para logging
log_message() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] $message" >> "$LOG_FILE"
}

## FunÃ§Ã£o para exibir mensagens coloridas e logar
msg() {
    local cor=$1
    local texto=$2
    local clean_text=$(echo -e "${texto}" | sed 's/\x1b\[[0-9;]*m//g')
    
    # Exibe no terminal com cor
    echo -e "${cor}${texto}${RESET}"
    
    # Salva no log sem cor
    log_message "$clean_text"
}

## FunÃ§Ã£o para executar comandos e logar
exec_log() {
    local cmd="$1"
    local description="$2"
    
    log_message "EXECUTANDO: $cmd"
    if [ -n "$description" ]; then
        log_message "DESCRIÃ‡ÃƒO: $description"
    fi
    
    # Executa comando e captura saÃ­da
    local output
    local exit_code
    
    output=$(eval "$cmd" 2>&1)
    exit_code=$?
    
    # Loga a saÃ­da
    if [ -n "$output" ]; then
        log_message "SAÃDA: $output"
    fi
    log_message "CÃ“DIGO DE SAÃDA: $exit_code"
    
    # Retorna o cÃ³digo de saÃ­da original
    return $exit_code
}

## FunÃ§Ã£o para validar nome da instÃ¢ncia
validar_nome_instancia() {
    local nome=$1
    # Remove caracteres especiais e converte para minÃºsculas
    nome=$(echo "$nome" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
    echo "$nome"
}

## FunÃ§Ã£o para gerar senha segura
gerar_senha() {
    local tamanho=$1
    # Gera senha com letras maiÃºsculas, minÃºsculas, nÃºmeros e caracteres especiais
    senha=$(openssl rand -base64 48 | tr -d "=+/" | cut -c1-$tamanho)
    # Garante que tenha pelo menos um de cada tipo
    senha="${senha}A1@"
    # Embaralha a senha
    senha=$(echo $senha | fold -w1 | shuf | tr -d '\n' | cut -c1-$tamanho)
    echo "$senha"
}

## FunÃ§Ã£o para verificar se Docker estÃ¡ instalado e funcionando
verificar_docker() {
    # Verifica se o comando docker existe
    if ! command -v docker &> /dev/null; then
        log_message "Docker comando nÃ£o encontrado"
        return 1
    fi
    
    # Verifica se o Docker daemon estÃ¡ rodando
    if ! docker info &> /dev/null; then
        log_message "Docker daemon nÃ£o estÃ¡ rodando ou nÃ£o responde"
        return 1
    fi
    
    # Testa se consegue executar um comando bÃ¡sico
    if ! docker ps &> /dev/null; then
        log_message "Docker ps falhou - problemas de conectividade com daemon"
        return 1
    fi
    
    log_message "Docker verificado e funcionando corretamente"
    return 0
}

## FunÃ§Ã£o para diagnosticar problemas do Docker
diagnosticar_docker() {
    msg "$AMARELO" "ðŸ” Diagnosticando problemas do Docker..."
    
    echo "ðŸ“ Verificando comando docker:"
    which docker || echo "âŒ Comando docker nÃ£o encontrado"
    
    echo ""
    echo "ðŸ“ Status do serviÃ§o Docker:"
    systemctl status docker --no-pager -l || echo "âŒ Erro ao verificar status"
    
    echo ""
    echo "ðŸ“ Tentando executar docker version:"
    docker version || echo "âŒ Erro ao executar docker version"
    
    echo ""
    echo "ðŸ“ Tentando executar docker info:"
    docker info || echo "âŒ Erro ao executar docker info"
    
    echo ""
    echo "ðŸ“ Verificando se o socket existe:"
    ls -la /var/run/docker.sock || echo "âŒ Socket nÃ£o encontrado"
}





## FunÃ§Ã£o para aguardar container ficar healthy
aguardar_container() {
    local container=$1
    local tentativas=0
    local max_tentativas=30
    
    msg "$AMARELO" "â³ Aguardando $container ficar online..."
    log_message "Aguardando container $container ficar online"
    
    while [ $tentativas -lt $max_tentativas ]; do
        if docker ps --filter "name=$container" --filter "status=running" | grep -q "$container"; then
            msg "$VERDE" "âœ… Container $container estÃ¡ online!"
            log_message "Container $container estÃ¡ online com sucesso"
            return 0
        fi
        sleep 5
        tentativas=$((tentativas + 1))
        
        # Mostra progresso a cada 6 tentativas (30 segundos)
        if [ $((tentativas % 6)) -eq 0 ]; then
            msg "$AMARELO" "â³ Ainda aguardando $container... ($tentativas/$max_tentativas)"
            log_message "Aguardando container $container... ($tentativas/$max_tentativas)"
        fi
    done
    
    msg "$VERMELHO" "âŒ Timeout aguardando $container"
    log_message "ERRO: Timeout aguardando container $container"
    msg "$AMARELO" "ðŸ” Status do container:"
    
    # Captura status do container para o log
    container_status=$(docker ps -a --filter "name=$container" 2>&1)
    log_message "Status do container $container: $container_status"
    docker ps -a --filter "name=$container" || echo "âŒ Erro ao verificar container"
    
    if docker ps -a --filter "name=$container" | grep -q "$container"; then
        msg "$AMARELO" "ðŸ“ Logs do container:"
        container_logs=$(docker logs --tail 20 "$container" 2>&1)
        log_message "Logs do container $container: $container_logs"
        docker logs --tail 20 "$container" || echo "âŒ Erro ao obter logs"
    fi
    return 1
}

## ===================================================================================================
##                                         COLETA DE INFORMAÃ‡Ã•ES
## ===================================================================================================

## ===================================================================================================
##                                    VERIFICAÃ‡ÃƒO DE REQUISITOS
## ===================================================================================================

# Verifica requisitos ANTES de inicializar qualquer coisa
verificar_requisitos_sistema

## ===================================================================================================
##                                       INICIALIZAÃ‡ÃƒO DO LOG
## ===================================================================================================

# Inicializa o arquivo de log
log_message "=========================================="
log_message "INÃCIO DA INSTALAÃ‡ÃƒO - NEUROBOOST DIGITAL"
log_message "=========================================="
log_message "Data/Hora: $(date)"
log_message "UsuÃ¡rio: $(whoami)"
log_message "DiretÃ³rio: $(pwd)"
log_message "Sistema: $(uname -a)"
log_message "Arquivo de log: $LOG_FILE"
log_message "Requisitos de sistema verificados e aprovados"

clear
msg "$BRANCO" "
â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   
â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•   â•šâ•â•   

        INSTALADOR DOCKER COMPOSE - TRAEFIK + PORTAINER + MINIO
"

msg "$VERDE" "âœ… Sistema compatÃ­vel: Ubuntu 24.04 LTS como root"
msg "$AMARELO" "ðŸ“ Log da instalaÃ§Ã£o: $LOG_FILE"

msg "$AMARELO" "=== CONFIGURAÃ‡ÃƒO INICIAL ==="
echo ""

## Nome da instÃ¢ncia
while true; do
    msg "$BRANCO" "Digite o nome da instÃ¢ncia (ex: cliente1, empresa2):"
    msg "$AMARELO" "âž¤ Este nome serÃ¡ usado como subdomÃ­nio para todas as aplicaÃ§Ãµes"
    read -p "> " nome_instancia_raw
    
    NOME_INSTANCIA=$(validar_nome_instancia "$nome_instancia_raw")
    
    if [ -z "$NOME_INSTANCIA" ]; then
        msg "$VERMELHO" "âŒ Nome invÃ¡lido! Use apenas letras, nÃºmeros e hÃ­fens."
        continue
    fi
    
    msg "$VERDE" "âœ“ Nome da instÃ¢ncia: $NOME_INSTANCIA"
    break
done

## Email para certificados SSL
echo ""
while true; do
    msg "$BRANCO" "Digite seu email (para notificaÃ§Ãµes SSL):"
    read -p "> " EMAIL_SSL
    
    if [[ "$EMAIL_SSL" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
        msg "$VERDE" "âœ“ Email: $EMAIL_SSL"
        break
    else
        msg "$VERMELHO" "âŒ Email invÃ¡lido!"
    fi
done

## Gera senhas automaticamente
msg "$AMARELO" ""
msg "$AMARELO" "ðŸ” Gerando senhas seguras..."
PASS_PORTAINER=$(gerar_senha 16)
PASS_MINIO=$(gerar_senha 12)
PASS_TRAEFIK=$(gerar_senha 14)

## Define usuÃ¡rios
USER_PORTAINER="$USUARIO_PADRAO"
USER_MINIO="$USUARIO_PADRAO"
USER_TRAEFIK="$USUARIO_PADRAO"

## Define URLs automÃ¡ticas
URL_TRAEFIK="traefik.${NOME_INSTANCIA}.${DOMINIO_BASE}"
URL_PORTAINER="portainer.${NOME_INSTANCIA}.${DOMINIO_BASE}"
URL_MINIO="minio.${NOME_INSTANCIA}.${DOMINIO_BASE}"
URL_S3="s3.${NOME_INSTANCIA}.${DOMINIO_BASE}"

## Resumo das configuraÃ§Ãµes
echo ""
msg "$AMARELO" "=== RESUMO DAS CONFIGURAÃ‡Ã•ES ==="
msg "$BRANCO" "Nome da InstÃ¢ncia: $VERDE$NOME_INSTANCIA"
msg "$BRANCO" "Email SSL: $VERDE$EMAIL_SSL"
msg "$BRANCO" "UsuÃ¡rio padrÃ£o: $VERDE$USUARIO_PADRAO"
msg "$BRANCO" "Fuso horÃ¡rio: $VERDE$(timedatectl show --property=Timezone --value)"
echo ""
msg "$BRANCO" "URLs que serÃ£o criadas:"
msg "$BRANCO" "  â€¢ Traefik: $VERDE$URL_TRAEFIK"
msg "$BRANCO" "  â€¢ Portainer: $VERDE$URL_PORTAINER"
msg "$BRANCO" "  â€¢ MinIO: $VERDE$URL_MINIO"
msg "$BRANCO" "  â€¢ S3: $VERDE$URL_S3"
echo ""

read -p "Confirmar e iniciar instalaÃ§Ã£o? (s/n): " confirmar
if [[ ! "$confirmar" =~ ^[Ss]$ ]]; then
    msg "$VERMELHO" "InstalaÃ§Ã£o cancelada."
    exit 1
fi

## ===================================================================================================
##                                    PREPARAÃ‡ÃƒO DO SISTEMA
## ===================================================================================================

clear
msg "$AMARELO" "=== PREPARANDO SISTEMA ==="
echo ""

## Atualiza sistema
msg "$BRANCO" "ðŸ“¦ Atualizando sistema..."
exec_log "apt-get update -qq" "Atualizando lista de pacotes"
exec_log "apt-get install -y -qq curl jq openssl apache2-utils tzdata ntp" "Instalando dependÃªncias bÃ¡sicas e ferramentas de tempo"
msg "$VERDE" "âœ… Sistema atualizado"

## Configura fuso horÃ¡rio para BrasÃ­lia
msg "$BRANCO" "ðŸ• Configurando fuso horÃ¡rio para BrasÃ­lia..."
exec_log "timedatectl set-timezone America/Sao_Paulo" "Definindo fuso horÃ¡rio para BrasÃ­lia"
exec_log "timedatectl set-ntp true" "Habilitando sincronizaÃ§Ã£o automÃ¡tica de tempo"
exec_log "systemctl enable systemd-timesyncd" "Habilitando serviÃ§o de sincronizaÃ§Ã£o de tempo"
exec_log "systemctl start systemd-timesyncd" "Iniciando serviÃ§o de sincronizaÃ§Ã£o de tempo"

# Aguarda sincronizaÃ§Ã£o
msg "$AMARELO" "â³ Aguardando sincronizaÃ§Ã£o de tempo..."
sleep 5

# Verifica configuraÃ§Ã£o
current_time=$(date)
current_tz=$(timedatectl show --property=Timezone --value)
msg "$VERDE" "âœ… Fuso horÃ¡rio configurado: $current_tz"
msg "$VERDE" "âœ… HorÃ¡rio atual: $current_time"
log_message "Fuso horÃ¡rio configurado: $current_tz"
log_message "HorÃ¡rio atual: $current_time"

## Instala Docker se necessÃ¡rio
if ! verificar_docker; then
    msg "$BRANCO" "ðŸ³ Instalando Docker..."
    
    # Instala Docker
    exec_log "curl -fsSL https://get.docker.com | bash" "Baixando e instalando Docker"
    
    # Habilita e inicia o serviÃ§o Docker
    exec_log "systemctl enable docker" "Habilitando serviÃ§o Docker"
    exec_log "systemctl start docker" "Iniciando serviÃ§o Docker"
    
    # Como o script executa como root, nÃ£o Ã© necessÃ¡rio adicionar ao grupo docker
    log_message "Executando como root - nÃ£o precisa adicionar ao grupo docker"
    
    # Atualiza PATH e recarrega comandos
    export PATH="/usr/bin:/usr/local/bin:$PATH"
    hash -r
    log_message "PATH atualizado: $PATH"
    
    # Aguarda o Docker inicializar completamente
    msg "$AMARELO" "â³ Aguardando Docker inicializar..."
    sleep 5
    
    # ForÃ§a restart do Docker daemon
    exec_log "systemctl restart docker" "Reiniciando Docker daemon"
    sleep 10
    
    # Verifica mÃºltiplas vezes se Docker estÃ¡ funcionando
    tentativas=0
    max_tentativas=6
    while [ $tentativas -lt $max_tentativas ]; do
        log_message "Tentativa $((tentativas+1))/$max_tentativas de verificaÃ§Ã£o do Docker"
        if verificar_docker; then
            msg "$VERDE" "âœ… Docker instalado e funcionando"
            log_message "Docker verificado e funcionando corretamente"
            break
        fi
        msg "$AMARELO" "â³ Aguardando Docker inicializar... (tentativa $((tentativas+1))/$max_tentativas)"
        sleep 10
        tentativas=$((tentativas + 1))
    done
    
    # VerificaÃ§Ã£o final
    if ! verificar_docker; then
        msg "$VERMELHO" "âŒ Erro: Docker nÃ£o estÃ¡ funcionando apÃ³s instalaÃ§Ã£o"
        log_message "ERRO: Docker nÃ£o funcionou apÃ³s instalaÃ§Ã£o"
        echo ""
        diagnosticar_docker
        echo ""
        msg "$AMARELO" "â„¹ï¸  Tente executar: systemctl restart docker && systemctl status docker"
        exit 1
    fi
else
    msg "$VERDE" "âœ… Docker jÃ¡ estÃ¡ instalado e funcionando"
    log_message "Docker jÃ¡ estava instalado e funcionando"
fi

## Cria diretÃ³rio do projeto
PROJETO_DIR="/root/${NOME_INSTANCIA}"
mkdir -p "$PROJETO_DIR"
cd "$PROJETO_DIR"

## Gera hash da senha do Traefik para Basic Auth
TRAEFIK_AUTH=$(htpasswd -nb $USER_TRAEFIK $PASS_TRAEFIK | sed -e 's/\$/\$\$/g')

## ===================================================================================================
##                                 CRIAÃ‡ÃƒO DO DOCKER-COMPOSE.YML
## ===================================================================================================

msg "$AMARELO" ""
msg "$AMARELO" "=== CRIANDO CONFIGURAÃ‡Ã•ES ==="
echo ""

## Cria docker-compose.yml com todos os serviÃ§os
## Cria arquivos docker-compose
msg "$BRANCO" "ðŸ“ Criando arquivos docker-compose..."

## Cria Traefik + Portainer juntos
cat > docker-compose.traefik-portainer.yml << EOF
version: '3.8'

services:
  traefik:
    image: traefik:v3.4.0
    container_name: ${NOME_INSTANCIA}_traefik
    restart: unless-stopped
    environment:
      - TZ=America/Sao_Paulo
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencryptresolver.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencryptresolver.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencryptresolver.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencryptresolver.acme.email=${EMAIL_SSL}"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
      - "/etc/localtime:/etc/localtime:ro"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(\`${URL_TRAEFIK}\`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencryptresolver"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_AUTH}"
    networks:
      - ${NOME_INSTANCIA}_network

  portainer:
    image: portainer/portainer-ce:latest
    container_name: ${NOME_INSTANCIA}_portainer
    restart: unless-stopped
    environment:
      - TZ=America/Sao_Paulo
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(\`${URL_PORTAINER}\`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=letsencryptresolver"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
    networks:
      - ${NOME_INSTANCIA}_network

volumes:
  portainer_data:

networks:
  ${NOME_INSTANCIA}_network:
    external: true
EOF

## Cria MinIO
cat > docker-compose.minio.yml << EOF
version: '3.8'

services:
  minio:
    image: quay.io/minio/minio:latest
    container_name: ${NOME_INSTANCIA}_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - TZ=America/Sao_Paulo
      - MINIO_ROOT_USER=${USER_MINIO}
      - MINIO_ROOT_PASSWORD=${PASS_MINIO}
      - MINIO_BROWSER_REDIRECT_URL=https://${URL_MINIO}
      - MINIO_SERVER_URL=https://${URL_S3}
    volumes:
      - minio_data:/data
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "traefik.enable=true"
      # Console do MinIO (porta 9001)
      - "traefik.http.routers.minio-console.rule=Host(\`${URL_MINIO}\`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=letsencryptresolver"
      - "traefik.http.routers.minio-console.service=minio-console-svc"
      - "traefik.http.services.minio-console-svc.loadbalancer.server.port=9001"
      # API S3 (porta 9000)
      - "traefik.http.routers.minio-api.rule=Host(\`${URL_S3}\`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls.certresolver=letsencryptresolver"
      - "traefik.http.routers.minio-api.service=minio-api-svc"
      - "traefik.http.services.minio-api-svc.loadbalancer.server.port=9000"
    networks:
      - ${NOME_INSTANCIA}_network

volumes:
  minio_data:

networks:
  ${NOME_INSTANCIA}_network:
    external: true
EOF

msg "$VERDE" "âœ… Arquivos docker-compose criados"



## ===================================================================================================
##                                    INICIANDO CONTAINERS
## ===================================================================================================

msg "$AMARELO" ""
msg "$AMARELO" "=== INICIANDO TODOS OS SERVIÃ‡OS ==="
echo ""

## Cria diretÃ³rio para certificados
mkdir -p letsencrypt

## Verifica se Docker estÃ¡ funcionando antes de iniciar containers
if ! verificar_docker; then
    msg "$VERMELHO" "âŒ Docker nÃ£o estÃ¡ funcionando corretamente"
    diagnosticar_docker
    exit 1
fi

## Cria rede compartilhada se nÃ£o existir
msg "$BRANCO" "ðŸŒ Verificando rede compartilhada..."
if docker network ls --format '{{.Name}}' | grep -q "^${NOME_INSTANCIA}_network$"; then
    msg "$VERDE" "âœ… Rede ${NOME_INSTANCIA}_network jÃ¡ existe"
    log_message "Rede ${NOME_INSTANCIA}_network jÃ¡ existia"
else
    if exec_log "docker network create --driver bridge ${NOME_INSTANCIA}_network" "Criando rede compartilhada"; then
        msg "$VERDE" "âœ… Rede compartilhada criada"
        log_message "Rede compartilhada criada com sucesso"
    else
        msg "$VERMELHO" "âŒ Erro ao criar rede"
        log_message "ERRO: Falha ao criar rede compartilhada"
        exit 1
    fi
fi

## Inicia todos os serviÃ§os
msg "$BRANCO" "ðŸš€ Iniciando Traefik, Portainer e MinIO..."

# Inicia Traefik + Portainer juntos
msg "$AMARELO" "ðŸ“¡ Iniciando Traefik e Portainer..."
if exec_log "docker compose -f docker-compose.traefik-portainer.yml up -d" "Deploy do Traefik e Portainer"; then
    msg "$VERDE" "âœ… Traefik e Portainer iniciados"
    log_message "Traefik e Portainer iniciados com sucesso"
else
    msg "$VERMELHO" "âŒ Erro ao iniciar Traefik e Portainer"
    log_message "ERRO: Falha ao iniciar Traefik e Portainer"
    exit 1
fi

# Aguarda Traefik e Portainer ficarem prontos
sleep 10

# Inicia MinIO
msg "$AMARELO" "ðŸ’¾ Iniciando MinIO..."
if exec_log "docker compose -f docker-compose.minio.yml up -d" "Deploy do MinIO"; then
    msg "$VERDE" "âœ… MinIO iniciado"
    log_message "MinIO iniciado com sucesso"
else
    msg "$VERMELHO" "âŒ Erro ao iniciar MinIO"
    log_message "ERRO: Falha ao iniciar MinIO"
    exit 1
fi

msg "$VERDE" "âœ… Todos os serviÃ§os iniciados com sucesso"

## Aguarda containers ficarem prontos
log_message "Aguardando containers ficarem prontos..."
aguardar_container "${NOME_INSTANCIA}_traefik"
aguardar_container "${NOME_INSTANCIA}_portainer"
aguardar_container "${NOME_INSTANCIA}_minio"

## ===================================================================================================
##                                    CONFIGURAÃ‡ÃƒO DO PORTAINER
## ===================================================================================================

msg "$AMARELO" ""
msg "$AMARELO" "=== CONFIGURANDO PORTAINER ==="
echo ""

sleep 20
msg "$BRANCO" "ðŸ‘¤ Configurando conta do Portainer..."
log_message "Configurando conta do Portainer via API"

CURL_CMD="curl -k -s -X POST \"https://$URL_PORTAINER/api/users/admin/init\" -H \"Content-Type: application/json\" -d \"{\\\"Username\\\": \\\"$USER_PORTAINER\\\", \\\"Password\\\": \\\"$PASS_PORTAINER\\\"}\""
log_message "Executando: $CURL_CMD"

RESPONSE=$(curl -k -s -X POST "https://$URL_PORTAINER/api/users/admin/init" \
    -H "Content-Type: application/json" \
    -d "{\"Username\": \"$USER_PORTAINER\", \"Password\": \"$PASS_PORTAINER\"}")

log_message "Resposta da API do Portainer: $RESPONSE"

if echo "$RESPONSE" | grep -q "\"Username\":\"$USER_PORTAINER\""; then
    msg "$VERDE" "âœ… Conta do Portainer criada com sucesso!"
    log_message "Conta do Portainer criada com sucesso"
elif echo "$RESPONSE" | grep -q "\"message\":\"User already exists\""; then
    msg "$VERDE" "âœ… Conta do Portainer jÃ¡ existe!"
    log_message "Conta do Portainer jÃ¡ existia"
elif echo "$RESPONSE" | grep -q "\"Id\".*\"Username\""; then
    msg "$VERDE" "âœ… Conta do Portainer configurada!"
    log_message "Conta do Portainer configurada com sucesso"
else
    msg "$AMARELO" "âš ï¸  NÃ£o foi possÃ­vel criar a conta automaticamente"
    msg "$AMARELO" "â„¹ï¸  Acesse o Portainer em atÃ© 5 minutos para criar a conta!"
    log_message "AVISO: NÃ£o foi possÃ­vel criar conta do Portainer automaticamente"
fi

## ===================================================================================================
##                                      SALVANDO CONFIGURAÃ‡Ã•ES
## ===================================================================================================

## Salva informaÃ§Ãµes em arquivo
cat > credenciais.txt << EOF
===================================================
         CREDENCIAIS E INFORMAÃ‡Ã•ES DE ACESSO
              NEUROBOOST DIGITAL
===================================================

Data da InstalaÃ§Ã£o: $(date)
Nome da InstÃ¢ncia: $NOME_INSTANCIA
DiretÃ³rio do Projeto: $PROJETO_DIR

===================================================
                 URLs DE ACESSO
===================================================

Traefik Dashboard: https://$URL_TRAEFIK
Portainer: https://$URL_PORTAINER
MinIO Console: https://$URL_MINIO
MinIO S3 API: https://$URL_S3

===================================================
                  CREDENCIAIS
===================================================

TRAEFIK DASHBOARD:
  URL: https://$URL_TRAEFIK
  UsuÃ¡rio: $USER_TRAEFIK
  Senha: $PASS_TRAEFIK

PORTAINER:
  URL: https://$URL_PORTAINER
  UsuÃ¡rio: $USER_PORTAINER
  Senha: $PASS_PORTAINER

MINIO:
  URL: https://$URL_MINIO
  UsuÃ¡rio: $USER_MINIO
  Senha: $PASS_MINIO

===================================================
                COMANDOS ÃšTEIS
===================================================

Entrar no diretÃ³rio:
  cd $PROJETO_DIR

Ver status dos containers:
  docker ps

Ver logs Traefik:
  docker compose -f docker-compose.traefik.yml logs -f

Ver logs Portainer:
  docker compose -f docker-compose.portainer.yml logs -f

Ver logs MinIO:
  docker compose -f docker-compose.minio.yml logs -f

Parar todos os serviÃ§os:
  docker compose -f docker-compose.traefik.yml down
  docker compose -f docker-compose.portainer.yml down
  docker compose -f docker-compose.minio.yml down

Reiniciar Traefik:
  docker compose -f docker-compose.traefik.yml restart

Reiniciar Portainer:
  docker compose -f docker-compose.portainer.yml restart

Reiniciar MinIO:
  docker compose -f docker-compose.minio.yml restart

Atualizar imagens:
  docker compose -f docker-compose.traefik.yml pull && docker compose -f docker-compose.traefik.yml up -d
  docker compose -f docker-compose.portainer.yml pull && docker compose -f docker-compose.portainer.yml up -d
  docker compose -f docker-compose.minio.yml pull && docker compose -f docker-compose.minio.yml up -d

===================================================
EOF

## Salva tambÃ©m em /root/dados_vps para backup
mkdir -p /root/dados_vps
cp credenciais.txt /root/dados_vps/${NOME_INSTANCIA}_credenciais.txt

## ===================================================================================================
##                                          FINALIZAÃ‡ÃƒO
## ===================================================================================================

clear
msg "$VERDE" "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           âœ… INSTALAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"

msg "$AMARELO" "=== INFORMAÃ‡Ã•ES IMPORTANTES - GUARDE ESTAS CREDENCIAIS ==="
echo ""

msg "$BRANCO" "ðŸ“‚ DiretÃ³rio do projeto: $VERDE$PROJETO_DIR"
echo ""

msg "$AMARELO" "ðŸ” CREDENCIAIS DE ACESSO:"
echo ""

msg "$BRANCO" "TRAEFIK DASHBOARD:"
msg "$BRANCO" "  ðŸŒ URL: $VERDE https://$URL_TRAEFIK"
msg "$BRANCO" "  ðŸ‘¤ UsuÃ¡rio: $VERDE$USER_TRAEFIK"
msg "$BRANCO" "  ðŸ”‘ Senha: $VERMELHO$PASS_TRAEFIK"
echo ""

msg "$BRANCO" "PORTAINER:"
msg "$BRANCO" "  ðŸŒ URL: $VERDE https://$URL_PORTAINER"
msg "$BRANCO" "  ðŸ‘¤ UsuÃ¡rio: $VERDE$USER_PORTAINER"
msg "$BRANCO" "  ðŸ”‘ Senha: $VERMELHO$PASS_PORTAINER"
echo ""

msg "$BRANCO" "MINIO:"
msg "$BRANCO" "  ðŸŒ Console: $VERDE https://$URL_MINIO"
msg "$BRANCO" "  ðŸŒ S3 API: $VERDE https://$URL_S3"
msg "$BRANCO" "  ðŸ‘¤ UsuÃ¡rio: $VERDE$USER_MINIO"
msg "$BRANCO" "  ðŸ”‘ Senha: $VERMELHO$PASS_MINIO"
echo ""

msg "$AMARELO" "ðŸ“„ Credenciais salvas em:"
msg "$BRANCO" "  â€¢ $PROJETO_DIR/credenciais.txt"
msg "$BRANCO" "  â€¢ /root/dados_vps/${NOME_INSTANCIA}_credenciais.txt"
echo ""
msg "$AMARELO" "ðŸ“ Estrutura de diretÃ³rios:"
msg "$BRANCO" "  â€¢ $PROJETO_DIR/ - DiretÃ³rio principal do cliente"
msg "$BRANCO" "  â€¢ $PROJETO_DIR/docker-compose.traefik-portainer.yml"
msg "$BRANCO" "  â€¢ $PROJETO_DIR/docker-compose.minio.yml"
msg "$BRANCO" "  â€¢ $PROJETO_DIR/credenciais.txt"
msg "$BRANCO" "  â€¢ $PROJETO_DIR/letsencrypt/ - Certificados SSL"
echo ""

msg "$AMARELO" "=== ARQUIVOS CRIADOS ==="
msg "$BRANCO" "â€¢ docker-compose.traefik-portainer.yml - Traefik + Portainer"
msg "$BRANCO" "â€¢ docker-compose.minio.yml - MinIO"
msg "$BRANCO" "â€¢ credenciais.txt - Todas as credenciais"
echo ""
msg "$AMARELO" "=== CONFIGURAÃ‡Ã•ES DE SISTEMA ==="
msg "$BRANCO" "â€¢ Fuso horÃ¡rio: $(timedatectl show --property=Timezone --value)"
msg "$BRANCO" "â€¢ SincronizaÃ§Ã£o NTP: $(timedatectl show --property=NTPSynchronized --value)"
msg "$BRANCO" "â€¢ HorÃ¡rio atual: $(date)"
echo ""

msg "$AMARELO" "=== PRÃ“XIMAS APLICAÃ‡Ã•ES ==="
msg "$BRANCO" "Para adicionar novas aplicaÃ§Ãµes:"
msg "$BRANCO" "1. Crie um novo arquivo docker-compose.app.yml"
msg "$BRANCO" "2. Use o padrÃ£o de URL: app.$NOME_INSTANCIA.$DOMINIO_BASE"
msg "$BRANCO" "3. Conecte Ã  rede: ${NOME_INSTANCIA}_network"
msg "$BRANCO" "4. Execute: docker compose -f docker-compose.app.yml up -d"
echo ""

msg "$AMARELO" "=== COMANDOS ÃšTEIS ==="
msg "$BRANCO" "â€¢ Ver status geral: cd $PROJETO_DIR && docker ps"
msg "$BRANCO" "â€¢ Ver logs Traefik: cd $PROJETO_DIR && docker compose -f docker-compose.traefik-portainer.yml logs -f traefik"
msg "$BRANCO" "â€¢ Ver logs Portainer: cd $PROJETO_DIR && docker compose -f docker-compose.traefik-portainer.yml logs -f portainer"
msg "$BRANCO" "â€¢ Ver logs MinIO: cd $PROJETO_DIR && docker compose -f docker-compose.minio.yml logs -f"
msg "$BRANCO" "â€¢ Reiniciar Traefik: cd $PROJETO_DIR && docker compose -f docker-compose.traefik-portainer.yml restart traefik"
msg "$BRANCO" "â€¢ Reiniciar Portainer: cd $PROJETO_DIR && docker compose -f docker-compose.traefik-portainer.yml restart portainer"
msg "$BRANCO" "â€¢ Reiniciar MinIO: cd $PROJETO_DIR && docker compose -f docker-compose.minio.yml restart"
echo ""

msg "$AMARELO" "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
msg "$AMARELO" "â•‘        NEUROBOOST DIGITAL - AutomaÃ§Ã£o e IA                     â•‘"
msg "$AMARELO" "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

## Finaliza o log
log_message "=========================================="
log_message "INSTALAÃ‡ÃƒO CONCLUÃDA COM SUCESSO"
log_message "=========================================="
log_message "Nome da instÃ¢ncia: $NOME_INSTANCIA"
log_message "Traefik: https://$URL_TRAEFIK"
log_message "Portainer: https://$URL_PORTAINER"
log_message "MinIO: https://$URL_MINIO"
log_message "S3: https://$URL_S3"
log_message "Fuso horÃ¡rio configurado: $(timedatectl show --property=Timezone --value)"
log_message "SincronizaÃ§Ã£o NTP: $(timedatectl show --property=NTPSynchronized --value)"
log_message "DiretÃ³rio do projeto: $PROJETO_DIR"
log_message "Credenciais salvas em: $PROJETO_DIR/credenciais.txt"
log_message "Log da instalaÃ§Ã£o: $LOG_FILE"
log_message "Data/Hora de conclusÃ£o: $(date)"
log_message "=========================================="

msg "$AMARELO" "ðŸ“ Log detalhado salvo em: $LOG_FILE"

## Arquivos docker-compose mantidos para consulta
msg "$BRANCO" "ðŸ“ Arquivos docker-compose mantidos para consulta futura:"
msg "$AMARELO" "â€¢ docker-compose.traefik-portainer.yml - Traefik + Portainer"
msg "$AMARELO" "â€¢ docker-compose.minio.yml - MinIO"
msg "$VERDE" "âœ… Arquivos preservados para manutenÃ§Ã£o"